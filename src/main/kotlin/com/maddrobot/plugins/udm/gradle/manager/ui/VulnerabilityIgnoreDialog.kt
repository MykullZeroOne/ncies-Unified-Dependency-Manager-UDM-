package com.maddrobot.plugins.udm.gradle.manager.ui

import com.intellij.openapi.project.Project
import com.intellij.openapi.ui.DialogWrapper
import com.intellij.ui.JBColor
import com.intellij.ui.components.JBLabel
import com.intellij.ui.components.JBScrollPane
import com.intellij.ui.components.JBTextArea
import com.intellij.util.ui.JBUI
import com.maddrobot.plugins.udm.PackageFinderBundle.message
import com.maddrobot.plugins.udm.gradle.manager.model.UnifiedPackage
import com.maddrobot.plugins.udm.gradle.manager.model.VulnerabilityInfo
import com.maddrobot.plugins.udm.gradle.manager.model.VulnerabilitySeverity
import java.awt.*
import javax.swing.*

/**
 * Confirmation dialog for ignoring a vulnerability.
 * Shows vulnerability details and asks for a reason/comment.
 */
class VulnerabilityIgnoreDialog(
    project: Project,
    private val pkg: UnifiedPackage,
    private val vulnInfo: VulnerabilityInfo
) : DialogWrapper(project) {

    private val reasonTextArea = JBTextArea(4, 40).apply {
        lineWrap = true
        wrapStyleWord = true
        border = JBUI.Borders.empty(4)
    }

    /**
     * The reason/comment entered by the user.
     */
    val reason: String get() = reasonTextArea.text.trim()

    init {
        title = message("unified.vulnerability.ignore.dialog.title")
        setOKButtonText(message("unified.vulnerability.ignore.dialog.confirm"))
        setCancelButtonText(message("unified.vulnerability.ignore.dialog.cancel"))
        init()
    }

    override fun createCenterPanel(): JComponent {
        val mainPanel = JPanel(BorderLayout(0, 12)).apply {
            border = JBUI.Borders.empty(8)
            preferredSize = Dimension(480, 340)
        }

        // Warning header
        val warningPanel = JPanel(FlowLayout(FlowLayout.LEFT, 8, 0)).apply {
            add(JBLabel(message("unified.vulnerability.ignore.dialog.warning")).apply {
                font = font.deriveFont(Font.BOLD, 13f)
                foreground = JBColor(0xE64A19, 0xFF7043)
            })
        }
        mainPanel.add(warningPanel, BorderLayout.NORTH)

        // Details panel
        val detailsPanel = JPanel().apply {
            layout = BoxLayout(this, BoxLayout.Y_AXIS)
            border = JBUI.Borders.empty(4)
        }

        // Package info
        detailsPanel.add(createDetailRow(
            message("unified.vulnerability.ignore.dialog.package"),
            "${pkg.publisher}:${pkg.name}:${pkg.installedVersion ?: "?"}"
        ))
        detailsPanel.add(Box.createVerticalStrut(4))

        // CVE ID
        if (vulnInfo.cveId != null) {
            detailsPanel.add(createDetailRow(
                message("unified.vulnerability.cve"),
                vulnInfo.cveId
            ))
            detailsPanel.add(Box.createVerticalStrut(4))
        }

        // Severity
        val severityColor = when (vulnInfo.severity) {
            VulnerabilitySeverity.CRITICAL -> JBColor(0xD32F2F, 0xEF5350)
            VulnerabilitySeverity.HIGH -> JBColor(0xE64A19, 0xFF7043)
            VulnerabilitySeverity.MEDIUM -> JBColor(0xF57C00, 0xFFB74D)
            VulnerabilitySeverity.LOW -> JBColor(0xFBC02D, 0xFFF176)
            VulnerabilitySeverity.UNKNOWN -> JBColor.GRAY
        }
        val severityRow = JPanel(FlowLayout(FlowLayout.LEFT, 4, 0)).apply {
            alignmentX = Component.LEFT_ALIGNMENT
            maximumSize = Dimension(Int.MAX_VALUE, 24)
            add(JBLabel(message("unified.vulnerability.severity")).apply {
                foreground = JBColor.GRAY
            })
            add(JBLabel(vulnInfo.severity.name).apply {
                foreground = severityColor
                font = font.deriveFont(Font.BOLD)
            })
        }
        detailsPanel.add(severityRow)
        detailsPanel.add(Box.createVerticalStrut(4))

        // Description
        if (vulnInfo.description != null) {
            detailsPanel.add(createDetailRow(
                message("unified.vulnerability.ignore.dialog.description"),
                vulnInfo.description
            ))
            detailsPanel.add(Box.createVerticalStrut(4))
        }

        // Fix version available
        if (vulnInfo.fixedVersion != null) {
            val fixRow = JPanel(FlowLayout(FlowLayout.LEFT, 4, 0)).apply {
                alignmentX = Component.LEFT_ALIGNMENT
                maximumSize = Dimension(Int.MAX_VALUE, 24)
                add(JBLabel(message("unified.vulnerability.fixed")).apply {
                    foreground = JBColor.GRAY
                })
                add(JBLabel(vulnInfo.fixedVersion).apply {
                    foreground = JBColor(0x4CAF50, 0x81C784)
                    font = font.deriveFont(Font.BOLD)
                })
            }
            detailsPanel.add(fixRow)
            detailsPanel.add(Box.createVerticalStrut(8))
        }

        // Separator
        detailsPanel.add(JSeparator().apply {
            alignmentX = Component.LEFT_ALIGNMENT
            maximumSize = Dimension(Int.MAX_VALUE, 2)
        })
        detailsPanel.add(Box.createVerticalStrut(8))

        // Reason/comment label
        detailsPanel.add(JBLabel(message("unified.vulnerability.ignore.dialog.reason.label")).apply {
            alignmentX = Component.LEFT_ALIGNMENT
            font = font.deriveFont(Font.BOLD)
        })
        detailsPanel.add(Box.createVerticalStrut(4))

        // Reason text area
        val scrollPane = JBScrollPane(reasonTextArea).apply {
            alignmentX = Component.LEFT_ALIGNMENT
            maximumSize = Dimension(Int.MAX_VALUE, 100)
            preferredSize = Dimension(0, 80)
        }
        detailsPanel.add(scrollPane)

        mainPanel.add(detailsPanel, BorderLayout.CENTER)

        return mainPanel
    }

    private fun createDetailRow(label: String, value: String): JPanel {
        return JPanel(FlowLayout(FlowLayout.LEFT, 4, 0)).apply {
            alignmentX = Component.LEFT_ALIGNMENT
            maximumSize = Dimension(Int.MAX_VALUE, 24)
            add(JBLabel(label).apply {
                foreground = JBColor.GRAY
            })
            add(JBLabel(value))
        }
    }

    override fun doOKAction() {
        if (reason.isBlank()) {
            reasonTextArea.requestFocusInWindow()
            return
        }
        super.doOKAction()
    }
}
